{% extends "base.html" %}

{% block title %}Dashboard - AI Call Analyzer{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <a href="{{ url_for('webhook_status') }}" class="btn btn-primary">
            <span>üîó</span> Configure Webhooks
        </a>
    </div>

    <!-- Summary Stats -->
    <div class="stats-grid">
        <div class="stat-card stat-card-primary">
            <div class="stat-icon">üìû</div>
            <div class="stat-content">
                <div class="stat-label">Total Calls</div>
                <div class="stat-value">{{ stats.total_calls }}</div>
            </div>
        </div>
        <div class="stat-card stat-card-success">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <div class="stat-label">Completed</div>
                <div class="stat-value">{{ stats.completed_calls }}</div>
            </div>
        </div>
        <div class="stat-card stat-card-info">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-content">
                <div class="stat-label">Avg Duration</div>
                <div class="stat-value">{{ stats.avg_duration_min }} min</div>
            </div>
        </div>
        <div class="stat-card stat-card-warning">
            <div class="stat-icon">‚ùì</div>
            <div class="stat-content">
                <div class="stat-label">Avg Questions</div>
                <div class="stat-value">{{ stats.avg_questions }}</div>
            </div>
        </div>
    </div>

    <!-- Score Trends Chart -->
    {% if score_trends and score_trends.trend %}
    <div class="section">
        <div class="section-header">
            <h2>üìà Score Trends</h2>
        </div>
        <div class="chart-container">
            <canvas id="scoreTrendsChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Leaderboard and Team Benchmarks Row -->
    <div class="dashboard-row">
        <!-- Leaderboard -->
        {% if leaderboard %}
        <div class="section leaderboard-section">
            <div class="section-header">
                <h2>üèÜ Agent Leaderboard</h2>
            </div>
            <div class="leaderboard">
                {% for agent in leaderboard %}
                <div class="leaderboard-item {% if loop.index <= 3 %}top-three{% endif %}">
                    <div class="rank">
                        {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                    </div>
                    <div class="agent-info">
                        <span class="agent-name">{{ agent.agent_name }}</span>
                        <span class="agent-stats-text">{{ agent.call_count }} calls</span>
                    </div>
                    <div class="agent-score {% if agent.avg_score >= 80 %}score-excellent{% elif agent.avg_score >= 60 %}score-good{% else %}score-fair{% endif %}">
                        {{ agent.avg_score }}
                        <div class="score-progress">
                            <div class="score-progress-fill" style="width: {{ agent.avg_score }}%"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if score_trends and score_trends.improvement != 0 %}
            <div class="trend-indicator {% if score_trends.improvement > 0 %}positive{% else %}negative{% endif %}">
                {% if score_trends.improvement > 0 %}üìà{% else %}üìâ{% endif %}
                Team average {% if score_trends.improvement > 0 %}improved{% else %}declined{% endif %} by {{ score_trends.improvement|abs }} points
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Team Benchmarks -->
        {% if benchmarks and benchmarks.total_calls > 0 %}
        <div class="section benchmarks-section">
            <div class="section-header">
                <h2>üìä Benchmarks</h2>
            </div>
            <div class="benchmarks-grid">
                <div class="benchmark-item">
                    <div class="benchmark-label">Avg Duration</div>
                    <div class="benchmark-value">{{ benchmarks.avg_duration }} min</div>
                    <div class="benchmark-median">Median: {{ benchmarks.median_duration }} min</div>
                </div>
                <div class="benchmark-item">
                    <div class="benchmark-label">Avg Talk Ratio</div>
                    <div class="benchmark-value">{{ benchmarks.avg_talk_ratio }}%</div>
                    <div class="benchmark-median">Median: {{ benchmarks.median_talk_ratio }}%</div>
                </div>
                <div class="benchmark-item">
                    <div class="benchmark-label">Avg Questions</div>
                    <div class="benchmark-value">{{ benchmarks.avg_questions }}</div>
                    <div class="benchmark-median">{{ benchmarks.avg_questions_per_min }}/min</div>
                </div>
                <div class="benchmark-item">
                    <div class="benchmark-label">Avg Filler Words</div>
                    <div class="benchmark-value">{{ benchmarks.avg_filler_words }}</div>
                    <div class="benchmark-median">Per call</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Recent Calls -->
    <div class="section">
        <div class="section-header">
            <h2>Recent Calls</h2>
            <a href="{{ url_for('history') }}" class="btn btn-sm btn-outline">View All</a>
        </div>

        {% if recent_calls %}
        <div class="calls-table">
            <table>
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in recent_calls %}
                    <tr>
                        <td>
                            <div class="agent-cell">
                                <span class="agent-icon">ü§ñ</span>
                                <span class="agent-name">{{ call.agent_name or 'Unknown Agent' }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ call.status }}">
                                {{ call.status }}
                            </span>
                        </td>
                        <td class="text-muted">
                            {{ call.created_at.strftime('%Y-%m-%d %H:%M') if call.created_at else '‚Äî' }}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if call.status == 'complete' %}
                                    <a href="{{ url_for('report', job_id=call.id) }}" class="btn-link">Report</a>
                                    <a href="{{ url_for('transcript', job_id=call.id) }}" class="btn-link">Transcript</a>
                                {% elif call.status == 'error' %}
                                    <span class="text-muted">Error</span>
                                {% else %}
                                    <span class="text-muted">Processing...</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üì°</div>
            <h3>No calls yet</h3>
            <p>Configure your ElevenLabs webhook to start receiving calls.</p>
            <a href="{{ url_for('webhook_status') }}" class="btn btn-primary">Configure Webhooks</a>
        </div>
        {% endif %}
    </div>

    <!-- Agents Summary -->
    {% if agents %}
    <div class="section">
        <div class="section-header">
            <h2>Active Agents</h2>
            <a href="{{ url_for('agents') }}" class="btn btn-sm btn-outline">View All</a>
        </div>
        <div class="agents-list">
            {% for agent in agents %}
            <div class="agent-card-mini">
                <span class="agent-avatar">ü§ñ</span>
                <span class="agent-name">{{ agent.agent_name or agent.agent_id[:8] }}</span>
                <a href="{{ url_for('history', agent=agent.agent_id) }}" class="btn-link">View Calls</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
.dashboard {
    max-width: 1200px;
    margin: 0 auto;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

.dashboard-header h1 {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--text), var(--primary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--border);
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.stat-icon { font-size: 36px; opacity: 0.8; }
.stat-content { flex: 1; }
.stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.stat-value { font-size: 32px; font-weight: 700; color: var(--text); line-height: 1.2; }

.stat-card-primary { background: linear-gradient(135deg, #e8f4fd 0%, #ffffff 100%); border-color: #b3d9ff; }
.stat-card-primary::before { background: linear-gradient(90deg, #0f62fe, #4d9eff); }
.stat-card-success { background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); border-color: #a5d6a7; }
.stat-card-success::before { background: linear-gradient(90deg, #24a148, #42be65); }
.stat-card-info { background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); border-color: #90caf9; }
.stat-card-info::before { background: linear-gradient(90deg, #0f62fe, #4589ff); }
.stat-card-warning { background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%); border-color: #ffcc80; }
.stat-card-warning::before { background: linear-gradient(90deg, #f1c21b, #fdd13a); }

.section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
}

.section-header h2 { font-size: 20px; font-weight: 600; }

.calls-table { overflow-x: auto; }
.calls-table table { width: 100%; border-collapse: collapse; }
.calls-table th { text-align: left; padding: 16px; font-size: 12px; font-weight: 700; color: var(--text-muted); background: var(--bg); border-bottom: 2px solid var(--border); text-transform: uppercase; }
.calls-table td { padding: 18px 16px; border-bottom: 1px solid var(--border); }
.calls-table tbody tr:hover { background: var(--bg); }

.agent-cell { display: flex; align-items: center; gap: 12px; }
.agent-icon { font-size: 20px; }
.agent-name { font-weight: 600; color: var(--text); }

.status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: capitalize; }
.status-complete { background: #d1f2eb; color: #0e7c5e; }
.status-pending, .status-analyzing, .status-queued { background: #fff3cd; color: #856404; }
.status-error { background: #f8d7da; color: #721c24; }

.action-buttons { display: flex; gap: 8px; }
.btn-link { padding: 6px 14px; color: var(--primary); text-decoration: none; font-weight: 600; font-size: 13px; border-radius: var(--radius-sm); transition: all 0.2s ease; }
.btn-link:hover { background: var(--primary); color: white; }

.empty-state { text-align: center; padding: 60px 20px; }
.empty-icon { font-size: 64px; margin-bottom: 16px; }
.empty-state h3 { font-size: 20px; margin-bottom: 8px; }
.empty-state p { color: var(--text-muted); margin-bottom: 24px; }

.agents-list { display: flex; flex-wrap: wrap; gap: 12px; }
.agent-card-mini { display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: var(--bg); border: 1.5px solid var(--border); border-radius: var(--radius); transition: all 0.3s ease; }
.agent-card-mini:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--primary); }
.agent-avatar { font-size: 20px; }

.dashboard-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
@media (max-width: 1024px) { .dashboard-row { grid-template-columns: 1fr; } }

.leaderboard { display: flex; flex-direction: column; gap: 8px; }
.leaderboard-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); }
.leaderboard-item.top-three { background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%); border: 2px solid #fbbf24; }
.leaderboard-item .rank { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; background: var(--card-bg); border-radius: 50%; border: 2px solid var(--border); }
.leaderboard-item.top-three .rank { font-size: 24px; border-color: #fbbf24; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
.leaderboard-item .agent-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.leaderboard-item .agent-stats-text { font-size: 12px; color: var(--text-muted); }
.agent-score { font-size: 24px; font-weight: 700; padding: 8px 16px; border-radius: var(--radius); min-width: 70px; text-align: center; }
.score-excellent { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border: 2px solid #86efac; }
.score-good { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; border: 2px solid #93c5fd; }
.score-fair { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 2px solid #fcd34d; }

.trend-indicator { margin-top: 16px; padding: 12px 18px; border-radius: var(--radius); font-size: 14px; font-weight: 600; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
.trend-indicator.positive { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; border: 1.5px solid #86efac; }
.trend-indicator.negative { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; border: 1.5px solid #fca5a5; }

.benchmarks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
.benchmark-item { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
.benchmark-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
.benchmark-value { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
.benchmark-median { font-size: 12px; color: var(--text-muted); }

.chart-container { position: relative; height: 300px; margin-top: 16px; }

.text-muted { color: var(--text-muted); }
</style>

<script>
{% if score_trends and score_trends.trend %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('scoreTrendsChart');
    if (!ctx) return;
    
    const trendData = {{ score_trends.trend | tojson }};
    const labels = trendData.map(item => {
        const [year, week] = item.week.split('-W');
        return `W${week}`;
    });
    const scores = trendData.map(item => item.avg_score);
    const counts = trendData.map(item => item.count);
    const avgScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Score',
                data: scores,
                borderColor: '#0f62fe',
                backgroundColor: 'rgba(15, 98, 254, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#0f62fe',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
            }, {
                label: 'Average',
                data: Array(scores.length).fill(avgScore),
                borderColor: '#667085',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            return `Calls: ${counts[context.dataIndex]}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.max(0, Math.min(...scores) - 10),
                    max: Math.min(100, Math.max(...scores) + 10),
                },
                x: { grid: { display: false } }
            }
        }
    });
});
{% endif %}
</script>
{% endblock %}

