{% extends "base.html" %}

{% block title %}Transcript - Sales Call Analyzer{% endblock %}

{% block content %}
<div class="transcript-container">
    <div class="transcript-header">
        <div>
            <h1>Call Transcript</h1>
            <p class="subtitle">{{ job.filename }}</p>
        </div>
        <div class="transcript-actions">
            <a href="{{ url_for('report', job_id=job.id) }}" class="btn btn-outline">View Report</a>
            <a href="{{ url_for('export_transcript', job_id=job.id, type='text') }}" class="btn btn-outline">Export TXT</a>
            <a href="{{ url_for('export_transcript', job_id=job.id, type='pdf') }}" class="btn btn-outline">Export PDF</a>
            <a href="{{ url_for('export_srt', job_id=job.id) }}" class="btn btn-outline">Export SRT</a>
        </div>
    </div>

    <!-- Visual Timeline -->
    {% if segments %}
    <div class="timeline-container">
        <h4>Conversation Timeline</h4>
        <div class="timeline-bar" id="timeline-bar">
            {% set total_duration = segments[-1].end if segments else 1 %}
            {% for segment in segments %}
            {% set left_pct = (segment.start / total_duration * 100) %}
            {% set width_pct = ((segment.end - segment.start) / total_duration * 100) %}
            <div 
                class="timeline-segment {{ 'agent' if segment.speaker == 'spk_0' else 'customer' }}"
                style="left: {{ left_pct }}%; width: {{ width_pct }}%;"
                data-start="{{ segment.start }}"
                title="{{ segment.speaker }}: {{ segment.text[:50] }}..."
            ></div>
            {% endfor %}
        </div>
        <div class="timeline-legend">
            <span class="legend-item agent"><span class="legend-dot"></span> Rep</span>
            <span class="legend-item customer"><span class="legend-dot"></span> Customer</span>
            <span class="timeline-duration">{{ ((segments[-1].end or 0) / 60)|round(1) }} min</span>
        </div>
    </div>
    {% endif %}

    <!-- Search and Controls -->
    <div class="transcript-controls">
        <div class="search-box">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search transcript..."
                class="form-input"
            >
            <button type="button" id="search-prev" class="btn btn-sm btn-outline" disabled>â†‘ Prev</button>
            <button type="button" id="search-next" class="btn btn-sm btn-outline" disabled>â†“ Next</button>
            <span id="search-results" class="search-results"></span>
        </div>
        <div class="view-options">
            <label>
                <input type="checkbox" id="show-pii" checked> Highlight PII
            </label>
            <label>
                <input type="checkbox" id="show-timestamps" checked> Show Timestamps
            </label>
            <label>
                <input type="checkbox" id="show-speakers" checked> Show Speakers
            </label>
        </div>
    </div>

    <!-- Transcript Content -->
    <div class="transcript-content" id="transcript-content">
        {% if segments %}
            {% for segment in segments %}
            <div 
                class="transcript-segment" 
                data-start="{{ segment.start }}" 
                data-end="{{ segment.end }}"
                data-segment-id="{{ segment.id }}"
            >
                <div class="segment-header">
                    {% if segment.start is defined and segment.start is not none %}
                    <button 
                        class="timestamp-link" 
                        data-time="{{ segment.start }}"
                        title="Click to jump to {{ segment.start|int }}s"
                    >
                        {% set minutes = (segment.start // 60)|int %}
                        {% set seconds = (segment.start % 60)|int %}
                        {{ minutes }}:{{ "%02d"|format(seconds) }}
                    </button>
                    {% endif %}
                    {% if segment.speaker %}
                    <span class="speaker-label {{ 'agent' if segment.speaker == 'spk_0' else 'customer' }}">
                        {{ 'Rep' if segment.speaker == 'spk_0' else 'Customer' }}
                    </span>
                    {% endif %}
                    <button class="add-note-btn" data-segment-id="{{ loop.index0 }}" data-time="{{ segment.start }}" title="Add coaching note">
                        ðŸ’¬
                    </button>
                </div>
                <div class="segment-text" data-text="{{ segment.text|lower }}">
                    {{ segment.text }}
                </div>
                <div class="segment-notes" id="notes-{{ loop.index0 }}"></div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Fallback to full text if no segments -->
            <div class="transcript-full">
                {{ redacted_text }}
            </div>
        {% endif %}
    </div>

    <!-- Coaching Notes Panel -->
    <div class="coaching-panel" id="coaching-panel">
        <div class="panel-header">
            <h3>Coaching Notes</h3>
            <button class="panel-close" onclick="toggleCoachingPanel()">&times;</button>
        </div>
        <div class="panel-content">
            <div id="notes-list"></div>
            <form id="note-form" class="note-form">
                <input type="hidden" id="note-timestamp" name="timestamp_sec">
                <textarea id="note-text" placeholder="Add a coaching note..." rows="3"></textarea>
                <button type="submit" class="btn btn-primary btn-sm">Add Note</button>
            </form>
        </div>
    </div>

    <!-- Timestamp Highlights from Analysis -->
    {% if timestamp_highlights %}
    <div class="timestamp-highlights">
        <h3>Key Moments</h3>
        <ul>
            {% for highlight in timestamp_highlights %}
            <li class="highlight-item">{{ highlight }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<!-- Note Modal -->
<div class="modal" id="note-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Coaching Note</h3>
            <button class="modal-close" onclick="closeNoteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-timestamp" id="modal-timestamp-display"></p>
            <textarea id="modal-note-text" placeholder="Enter your coaching feedback..." rows="4"></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeNoteModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Transcript data
const segments = {{ segments|tojson }};
const piiFindings = {{ pii_findings|tojson }};
const timestampHighlights = {{ timestamp_highlights|tojson }};

// Search functionality
let currentSearchIndex = -1;
let searchMatches = [];

const searchInput = document.getElementById('search-input');
const searchPrev = document.getElementById('search-prev');
const searchNext = document.getElementById('search-next');
const searchResults = document.getElementById('search-results');
const transcriptContent = document.getElementById('transcript-content');

searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    
    if (query.length < 2) {
        searchMatches = [];
        currentSearchIndex = -1;
        clearHighlights();
        updateSearchUI();
        return;
    }
    
    // Find all matches
    searchMatches = [];
    const segmentElements = document.querySelectorAll('.segment-text');
    
    segmentElements.forEach((el, idx) => {
        const text = el.textContent.toLowerCase();
        const segmentText = el.textContent;
        let index = text.indexOf(query);
        
        while (index !== -1) {
            searchMatches.push({
                element: el,
                index: index,
                length: query.length,
                segmentIndex: idx,
            });
            index = text.indexOf(query, index + 1);
        }
    });
    
    if (searchMatches.length > 0) {
        currentSearchIndex = 0;
        highlightSearchMatches();
        scrollToMatch(0);
    } else {
        currentSearchIndex = -1;
        clearHighlights();
    }
    
    updateSearchUI();
});

function highlightSearchMatches() {
    clearHighlights();
    
    searchMatches.forEach((match, idx) => {
        const el = match.element;
        const text = el.textContent;
        const query = searchInput.value.toLowerCase().trim();
        const start = match.index;
        const end = start + match.length;
        
        // Create highlighted version
        const before = text.substring(0, start);
        const highlighted = text.substring(start, end);
        const after = text.substring(end);
        
        el.innerHTML = `${escapeHtml(before)}<mark class="search-highlight ${idx === currentSearchIndex ? 'current' : ''}">${escapeHtml(highlighted)}</mark>${escapeHtml(after)}`;
    });
}

function clearHighlights() {
    const segmentElements = document.querySelectorAll('.segment-text');
    segmentElements.forEach(el => {
        // Restore original text (from data attribute if available, otherwise textContent)
        const originalText = el.getAttribute('data-text') || el.textContent;
        el.innerHTML = escapeHtml(originalText);
    });
}

function scrollToMatch(index) {
    if (index < 0 || index >= searchMatches.length) return;
    
    const match = searchMatches[index];
    match.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    match.element.classList.add('search-scroll-target');
    setTimeout(() => {
        match.element.classList.remove('search-scroll-target');
    }, 1000);
}

function updateSearchUI() {
    if (searchMatches.length > 0) {
        searchPrev.disabled = false;
        searchNext.disabled = false;
        searchResults.textContent = `${currentSearchIndex + 1} of ${searchMatches.length}`;
    } else {
        searchPrev.disabled = true;
        searchNext.disabled = true;
        searchResults.textContent = searchInput.value.trim() ? 'No matches' : '';
    }
}

searchPrev.addEventListener('click', function() {
    if (searchMatches.length === 0) return;
    currentSearchIndex = (currentSearchIndex - 1 + searchMatches.length) % searchMatches.length;
    highlightSearchMatches();
    scrollToMatch(currentSearchIndex);
    updateSearchUI();
});

searchNext.addEventListener('click', function() {
    if (searchMatches.length === 0) return;
    currentSearchIndex = (currentSearchIndex + 1) % searchMatches.length;
    highlightSearchMatches();
    scrollToMatch(currentSearchIndex);
    updateSearchUI();
});

// Keyboard shortcuts
searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        if (e.shiftKey) {
            searchPrev.click();
        } else {
            searchNext.click();
        }
    }
});

// Timestamp links
document.querySelectorAll('.timestamp-link').forEach(link => {
    link.addEventListener('click', function() {
        const time = parseFloat(this.getAttribute('data-time'));
        // Scroll to segment
        const segment = this.closest('.transcript-segment');
        segment.scrollIntoView({ behavior: 'smooth', block: 'center' });
        segment.classList.add('timestamp-highlight');
        setTimeout(() => {
            segment.classList.remove('timestamp-highlight');
        }, 2000);
    });
});

// View options
document.getElementById('show-timestamps').addEventListener('change', function() {
    document.querySelectorAll('.timestamp-link').forEach(el => {
        el.style.display = this.checked ? 'inline-block' : 'none';
    });
});

document.getElementById('show-speakers').addEventListener('change', function() {
    document.querySelectorAll('.speaker-label').forEach(el => {
        el.style.display = this.checked ? 'inline-block' : 'none';
    });
});

// PII highlighting (if we have PII findings data)
if (piiFindings && piiFindings.length > 0 && document.getElementById('show-pii').checked) {
    // Note: PII is already redacted in the text, but we could highlight the redacted portions
    // For now, we'll just show a note about redactions
}

document.getElementById('show-pii').addEventListener('change', function() {
    // Toggle PII highlighting if implemented
});

// Helper function
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Timeline click navigation
document.querySelectorAll('.timeline-segment').forEach(seg => {
    seg.addEventListener('click', function() {
        const startTime = parseFloat(this.getAttribute('data-start'));
        // Find matching transcript segment
        const segments = document.querySelectorAll('.transcript-segment');
        for (const segment of segments) {
            const segStart = parseFloat(segment.getAttribute('data-start'));
            if (Math.abs(segStart - startTime) < 1) {
                segment.scrollIntoView({ behavior: 'smooth', block: 'center' });
                segment.classList.add('timestamp-highlight');
                setTimeout(() => segment.classList.remove('timestamp-highlight'), 2000);
                break;
            }
        }
    });
});

// Coaching Notes functionality
const jobId = "{{ job.id }}";
let currentNoteTime = null;
let annotations = [];

// Load existing annotations
async function loadAnnotations() {
    try {
        const response = await fetch(`/api/annotations/${jobId}`);
        if (response.ok) {
            const data = await response.json();
            annotations = data.annotations || [];
            renderAnnotations();
        }
    } catch (e) {
        console.error('Failed to load annotations:', e);
    }
}

function renderAnnotations() {
    // Clear all inline notes
    document.querySelectorAll('.segment-notes').forEach(el => el.innerHTML = '');
    
    // Add annotations to appropriate segments
    annotations.forEach(ann => {
        const time = ann.timestamp_sec;
        // Find closest segment
        let closestSegment = null;
        let closestDiff = Infinity;
        
        document.querySelectorAll('.transcript-segment').forEach(seg => {
            const start = parseFloat(seg.getAttribute('data-start'));
            const end = parseFloat(seg.getAttribute('data-end'));
            if (time >= start && time <= end) {
                closestSegment = seg;
                closestDiff = 0;
            } else if (Math.abs(start - time) < closestDiff) {
                closestSegment = seg;
                closestDiff = Math.abs(start - time);
            }
        });
        
        if (closestSegment) {
            const notesContainer = closestSegment.querySelector('.segment-notes');
            if (notesContainer) {
                const noteEl = document.createElement('div');
                noteEl.className = 'inline-note';
                noteEl.innerHTML = `
                    <span class="note-icon">ðŸ’¬</span>
                    <span class="note-text">${escapeHtml(ann.note)}</span>
                    <button class="note-delete" data-id="${ann.id}" title="Delete">&times;</button>
                `;
                notesContainer.appendChild(noteEl);
            }
        }
    });
    
    // Add delete handlers
    document.querySelectorAll('.note-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            const annId = this.getAttribute('data-id');
            await deleteAnnotation(annId);
        });
    });
}

// Add note button handlers
document.querySelectorAll('.add-note-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const time = parseFloat(this.getAttribute('data-time'));
        openNoteModal(time);
    });
});

function openNoteModal(time) {
    currentNoteTime = time;
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    document.getElementById('modal-timestamp-display').textContent = 
        `At ${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('modal-note-text').value = '';
    document.getElementById('note-modal').classList.add('show');
}

function closeNoteModal() {
    document.getElementById('note-modal').classList.remove('show');
    currentNoteTime = null;
}

async function saveNote() {
    const noteText = document.getElementById('modal-note-text').value.trim();
    if (!noteText) return;
    
    try {
        const response = await fetch(`/api/annotations/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                note: noteText,
                timestamp_sec: currentNoteTime
            })
        });
        
        if (response.ok) {
            closeNoteModal();
            await loadAnnotations();
        }
    } catch (e) {
        console.error('Failed to save annotation:', e);
    }
}

async function deleteAnnotation(annId) {
    if (!confirm('Delete this note?')) return;
    
    try {
        const response = await fetch(`/api/annotations/${annId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            await loadAnnotations();
        }
    } catch (e) {
        console.error('Failed to delete annotation:', e);
    }
}

// Toggle coaching panel
function toggleCoachingPanel() {
    document.getElementById('coaching-panel').classList.toggle('show');
}

// Load annotations on page load
loadAnnotations();

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeNoteModal();
    }
});
</script>

<style>
.transcript-container {
    max-width: 1000px;
    margin: 0 auto;
}

.transcript-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.transcript-header h1 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 4px;
}

.subtitle {
    color: var(--text-muted);
    font-size: 14px;
}

.transcript-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.transcript-controls {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
}

.search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.search-box .form-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
}

.search-results {
    font-size: 13px;
    color: var(--text-muted);
    margin-left: auto;
}

.view-options {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.view-options label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    cursor: pointer;
}

.transcript-content {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    max-height: 70vh;
    overflow-y: auto;
    line-height: 1.8;
}

.transcript-segment {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
}

.transcript-segment:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.segment-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    font-size: 13px;
}

.timestamp-link {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s;
}

.timestamp-link:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.speaker-label {
    background: var(--bg);
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
}

.segment-text {
    font-size: 15px;
    line-height: 1.8;
    color: var(--text);
}

.transcript-full {
    white-space: pre-wrap;
    font-size: 15px;
    line-height: 1.8;
}

.search-highlight {
    background: #fff3cd;
    padding: 2px 0;
    border-radius: 2px;
}

.search-highlight.current {
    background: #ffc107;
    font-weight: 600;
}

.search-scroll-target {
    animation: highlight-pulse 1s ease-in-out;
}

@keyframes highlight-pulse {
    0%, 100% { background: transparent; }
    50% { background: rgba(15, 98, 254, 0.1); }
}

.timestamp-highlight {
    animation: timestamp-pulse 2s ease-in-out;
}

@keyframes timestamp-pulse {
    0%, 100% { background: transparent; }
    50% { background: rgba(15, 98, 254, 0.15); }
}

.timestamp-highlights {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-top: 24px;
    box-shadow: var(--shadow);
}

.timestamp-highlights h3 {
    font-size: 18px;
    margin-bottom: 16px;
}

.timestamp-highlights ul {
    list-style: none;
    padding: 0;
}

.highlight-item {
    padding: 12px;
    margin-bottom: 8px;
    background: var(--bg);
    border-left: 3px solid var(--primary);
    border-radius: var(--radius-sm);
}

/* Timeline Styles */
.timeline-container {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
}

.timeline-container h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--text-muted);
}

.timeline-bar {
    position: relative;
    height: 24px;
    background: #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
}

.timeline-segment {
    position: absolute;
    height: 100%;
    min-width: 2px;
    transition: opacity 0.2s;
}

.timeline-segment:hover {
    opacity: 0.8;
}

.timeline-segment.agent {
    background: var(--primary);
}

.timeline-segment.customer {
    background: #64748b;
}

.timeline-legend {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 8px;
    font-size: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-muted);
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.legend-item.agent .legend-dot {
    background: var(--primary);
}

.legend-item.customer .legend-dot {
    background: #64748b;
}

.timeline-duration {
    margin-left: auto;
    font-weight: 600;
}

/* Speaker Labels */
.speaker-label.agent {
    background: var(--primary);
    color: white;
}

.speaker-label.customer {
    background: #64748b;
    color: white;
}

/* Add Note Button */
.add-note-btn {
    background: none;
    border: none;
    cursor: pointer;
    opacity: 0.3;
    font-size: 14px;
    padding: 4px;
    transition: opacity 0.2s;
}

.transcript-segment:hover .add-note-btn {
    opacity: 1;
}

.add-note-btn:hover {
    transform: scale(1.2);
}

/* Segment Notes */
.segment-notes {
    margin-top: 8px;
}

.inline-note {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    background: #fef3c7;
    border-left: 3px solid #f59e0b;
    padding: 8px 12px;
    margin-top: 8px;
    border-radius: var(--radius-sm);
    font-size: 13px;
}

.inline-note .note-icon {
    flex-shrink: 0;
}

.inline-note .note-text {
    flex: 1;
    color: #92400e;
}

.inline-note .note-delete {
    background: none;
    border: none;
    color: #92400e;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    opacity: 0.5;
}

.inline-note .note-delete:hover {
    opacity: 1;
}

/* Note Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
}

.modal-body {
    padding: 20px;
}

.modal-timestamp {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.modal-body textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    resize: vertical;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    background: var(--bg);
}

/* Coaching Panel (side panel) */
.coaching-panel {
    position: fixed;
    right: -400px;
    top: 0;
    width: 400px;
    height: 100vh;
    background: var(--card-bg);
    border-left: 1px solid var(--border);
    box-shadow: -5px 0 25px rgba(0,0,0,0.1);
    z-index: 100;
    transition: right 0.3s ease;
}

.coaching-panel.show {
    right: 0;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

.panel-header h3 {
    margin: 0;
}

.panel-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
}

.panel-content {
    padding: 20px;
    overflow-y: auto;
    height: calc(100vh - 60px);
}
</style>
{% endblock %}

