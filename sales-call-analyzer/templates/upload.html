{% extends "base.html" %}

{% block title %}Upload Call - Sales Call Analyzer{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-card">
        <div class="upload-header">
            <h1>Upload Sales Call</h1>
            <p class="subtitle" id="subtitle">Drop an audio file to analyze. We'll redact PII and generate a coaching report.</p>
        </div>

        <!-- Call Type Tabs -->
        <div class="call-type-tabs">
            <button type="button" class="tab-btn tab-real active" data-call-type="real" id="tab-real">
                <span class="tab-icon">üë§</span>
                <span class="tab-label">Real Calls</span>
                <span class="tab-desc">With Customers</span>
            </button>
            <button type="button" class="tab-btn tab-ai" data-call-type="ai_agent" id="tab-ai">
                <span class="tab-icon">ü§ñ</span>
                <span class="tab-label">AI Agent Calls</span>
                <span class="tab-desc">Simulated/Test</span>
            </button>
        </div>
        <input type="hidden" name="call_type" id="call_type" value="real">
        
        <!-- Call Type Warning/Info Box -->
        <div class="call-type-info" id="call-type-info">
            <div class="info-icon" id="info-icon">üîí</div>
            <div class="info-content">
                <h4 id="info-title">Real Customer Call</h4>
                <p id="info-description">
                    This is a <strong>real call with actual customers</strong>. PII (names, phone numbers, emails) will be automatically redacted before analysis to protect customer privacy.
                </p>
            </div>
        </div>

        <form method="POST" enctype="multipart/form-data" id="upload-form">
            <div class="dropzone" id="dropzone">
                <div class="dropzone-content">
                    <div class="dropzone-icon">üéôÔ∏è</div>
                    <p class="dropzone-text">Drag & drop your audio file(s) here</p>
                    <p class="dropzone-hint">or click to browse (multiple files supported)</p>
                    <p class="dropzone-formats">MP3, WAV, M4A, OGG, FLAC, WebM (max 100MB each)</p>
                </div>
                <input 
                    type="file" 
                    id="audio" 
                    name="audio" 
                    accept=".mp3,.wav,.m4a,.ogg,.flac,.webm,.mp4"
                    multiple
                    required
                    hidden
                >
            </div>

            <div class="file-preview" id="file-preview" style="display: none;">
                <div class="file-info">
                    <span class="file-icon">üìÅ</span>
                    <span class="file-name" id="file-name"></span>
                    <span class="file-size" id="file-size"></span>
                </div>
                <button type="button" class="btn btn-sm btn-outline" id="clear-file">Remove</button>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="rep_name" class="form-label">Rep Name (Optional)</label>
                <input 
                    type="text" 
                    id="rep_name" 
                    name="rep_name" 
                    class="form-input" 
                    placeholder="e.g., John Smith"
                >
                <small class="form-hint">Assign this call to a specific sales rep for tracking</small>
            </div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn" disabled>
                Analyze Call
            </button>
        </form>

        <div class="upload-info" id="upload-info">
            <h3>What happens next?</h3>
            <ol id="process-steps">
                <li>üîí <strong>PII Redaction</strong> - Names, numbers, and sensitive info are automatically redacted</li>
                <li>ü§ñ <strong>AI Analysis</strong> - GPT-4o reviews the call and generates coaching feedback</li>
                <li>üìÑ <strong>Reports</strong> - You'll receive a coaching report and call stats via email</li>
            </ol>
            <p class="privacy-note" id="privacy-note">
                <strong>Privacy:</strong> Your audio never leaves our servers unredacted. 
                Only the anonymized transcript is sent to OpenAI for analysis.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('audio');
const filePreview = document.getElementById('file-preview');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const clearBtn = document.getElementById('clear-file');
const submitBtn = document.getElementById('submit-btn');

// Click to browse
dropzone.addEventListener('click', () => fileInput.click());

// Drag events
dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
});

dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
});

dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        updateFilePreview();
    }
});

// File selection
fileInput.addEventListener('change', updateFilePreview);

function updateFilePreview() {
    if (fileInput.files.length) {
        const files = Array.from(fileInput.files);
        if (files.length === 1) {
            const file = files[0];
            fileName.textContent = file.name;
            fileSize.textContent = formatBytes(file.size);
        } else {
            fileName.textContent = `${files.length} files selected`;
            const totalSize = files.reduce((sum, f) => sum + f.size, 0);
            fileSize.textContent = formatBytes(totalSize);
        }
        filePreview.style.display = 'flex';
        dropzone.style.display = 'none';
        submitBtn.disabled = false;
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

clearBtn.addEventListener('click', () => {
    fileInput.value = '';
    filePreview.style.display = 'none';
    dropzone.style.display = 'flex';
    submitBtn.disabled = true;
});

// Form submission
document.getElementById('upload-form').addEventListener('submit', () => {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner"></span> Uploading...';
});

// Tab switching
const tabButtons = document.querySelectorAll('.tab-btn');
const callTypeInput = document.getElementById('call_type');
const subtitle = document.getElementById('subtitle');
const processSteps = document.getElementById('process-steps');
const privacyNote = document.getElementById('privacy-note');
const callTypeInfo = document.getElementById('call-type-info');
const infoIcon = document.getElementById('info-icon');
const infoTitle = document.getElementById('info-title');
const infoDescription = document.getElementById('info-description');

function updateCallTypeUI(callType) {
    // Update active tab
    tabButtons.forEach(b => {
        b.classList.remove('active');
        if (b.dataset.callType === callType) {
            b.classList.add('active');
        }
    });
    
    // Update call type input
    callTypeInput.value = callType;
    
    // Update UI based on call type
    if (callType === 'ai_agent') {
        // AI Agent Call UI
        subtitle.textContent = 'Drop an audio file to analyze. We\'ll analyze the call and generate a coaching report (no PII redaction needed).';
        processSteps.innerHTML = `
            <li>üéôÔ∏è <strong>Transcription</strong> - Audio is transcribed to text</li>
            <li>ü§ñ <strong>AI Analysis</strong> - GPT-4o reviews the call and generates coaching feedback</li>
            <li>üìÑ <strong>Reports</strong> - You'll receive a coaching report and call stats via email</li>
        `;
        privacyNote.innerHTML = `
            <strong>Note:</strong> AI agent calls don't require PII redaction since they don't contain real customer data. 
            The full transcript is analyzed for coaching insights.
        `;
        
        // Update info box
        callTypeInfo.className = 'call-type-info info-ai';
        infoIcon.textContent = 'ü§ñ';
        infoTitle.textContent = 'AI Agent / Simulated Call';
        infoDescription.innerHTML = `
            This is an <strong>AI agent call or simulated/test call</strong> with no real customer data. 
            PII redaction is <strong>NOT performed</strong> since there's no sensitive information to protect. 
            The full transcript is analyzed for coaching insights.
        `;
    } else {
        // Real Call UI
        subtitle.textContent = 'Drop an audio file to analyze. We\'ll redact PII and generate a coaching report.';
        processSteps.innerHTML = `
            <li>üîí <strong>PII Redaction</strong> - Names, numbers, and sensitive info are automatically redacted</li>
            <li>ü§ñ <strong>AI Analysis</strong> - GPT-4o reviews the call and generates coaching feedback</li>
            <li>üìÑ <strong>Reports</strong> - You'll receive a coaching report and call stats via email</li>
        `;
        privacyNote.innerHTML = `
            <strong>Privacy:</strong> Your audio never leaves our servers unredacted. 
            Only the anonymized transcript is sent to OpenAI for analysis.
        `;
        
        // Update info box
        callTypeInfo.className = 'call-type-info info-real';
        infoIcon.textContent = 'üîí';
        infoTitle.textContent = 'Real Customer Call';
        infoDescription.innerHTML = `
            This is a <strong>real call with actual customers</strong>. PII (names, phone numbers, emails) 
            will be automatically redacted before analysis to protect customer privacy.
        `;
    }
}

tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const callType = btn.dataset.callType;
        updateCallTypeUI(callType);
    });
});

// Initialize UI
updateCallTypeUI('real');
</script>
{% endblock %}

